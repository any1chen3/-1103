<?xml version="1.0" encoding="UTF-8"?>
<!-- MyBatis XML约束：告诉IDEA此文件是MyBatis配置文件，按规范解析标签（如<select>、<insert>） -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace：必须与Mapper接口的全路径一致，绑定接口与XML -->
<!-- 若不一致，MyBatis无法找到SQL与方法的对应关系，调用时会报“方法未找到”错误 -->
<mapper namespace="com.military.asset.mapper.SoftwareAssetMapper">

    <!-- 实现selectAllExistingIds方法：查询所有已存在的ID -->
    <!-- id：必须与Mapper接口的方法名一致；resultType：SQL结果的类型（数据库id是VARCHAR，对应Java String） -->
    <select id="selectAllExistingIds" resultType="java.lang.String">
        SELECT id FROM software_asset
        <!-- 无WHERE条件，查询表中所有ID -->
    </select>

    <!-- 实现insertBatch方法：批量插入软件资产 -->
    <!-- id：与接口方法名一致；parameterType：参数类型（List<SoftwareAsset>，MyBatis支持直接传List） -->
    <!-- useGeneratedKeys="false"：主键手动输入，无需数据库自动生成（与@TableId(type=INPUT)一致） -->
    <insert id="insertBatch" parameterType="java.util.List" useGeneratedKeys="false">
        INSERT INTO software_asset (
        id,                  -- 主键（对应实体id字段）
        title,               -- 标题（对应title）
        data_audit_opinion,   -- 数据审核意见（对应dataAuditOpinion，下划线转驼峰）
        report_unit,         -- 上报单位（对应reportUnit）
        category_code,       -- 分类编码（对应categoryCode）
        asset_category,      -- 资产分类（对应assetCategory）
        asset_name,          -- 资产名称（对应assetName）
        acquisition_method,  -- 取得方式（对应acquisitionMethod）
        deployment_scope,    -- 部署范围（对应deploymentScope）
        service_status,      -- 服务状态（对应serviceStatus）
        actual_quantity,     -- 实有数量（对应actualQuantity）
        unit,                -- 计量单位（对应unit）
        put_into_use_date,   -- 投入使用日期（对应putIntoUseDate，LocalDate自动匹配DATE类型）
        inventory_unit,      -- 盘点单位（对应inventoryUnit）
        function_brief,      -- 功能简述（对应functionBrief）
        deployment_form,     -- 部署形式（对应deploymentForm）
        bearing_network,     -- 承载网络（对应bearingNetwork）
        software_copyright,  -- 软件著作权人（对应softwareCopyright）
        unit_price,          -- 单价（对应unitPrice，Double匹配DECIMAL）
        amount,              -- 金额（对应amount）
        pricing_method,      -- 计价方法（对应pricingMethod）
        pricing_description, -- 计价说明（对应pricingDescription）
        inventory_remark,    -- 盘点备注（对应inventoryRemark）
        valuation_remark,    -- 核价备注（对应valuationRemark）
        original_account_remark, -- 原始帐备注（对应originalAccountRemark）
        create_time          -- 入库时间（对应createTime，由数据库自动生成）
        ) VALUES
        <!-- foreach：循环List集合，批量生成VALUES子句 -->
        <!-- collection="list"：参数是List，默认变量名“list”（与@Param("list")一致） -->
        <!-- item="item"：循环中每个元素的别名（单个SoftwareAsset实体） -->
        <!-- separator=","：每个VALUES之间用逗号分隔（如VALUES (1),(2),(3)） -->
        <foreach collection="list" item="item" separator=",">
            (
            #{item.id},                  -- 取实体的id字段（调用item.getId()）
            #{item.title},               -- 取title
            #{item.dataAuditOpinion},    -- 取dataAuditOpinion
            #{item.reportUnit},          -- 取reportUnit
            #{item.categoryCode},        -- 取categoryCode
            #{item.assetCategory},       -- 取assetCategory
            #{item.assetName},           -- 取assetName
            #{item.acquisitionMethod},   -- 取acquisitionMethod
            #{item.deploymentScope},     -- 取deploymentScope
            #{item.serviceStatus},       -- 取serviceStatus
            #{item.actualQuantity},      -- 取actualQuantity
            #{item.unit},                 -- 取unit
            #{item.putIntoUseDate},       -- 取putIntoUseDate
            #{item.inventoryUnit},       -- 取inventoryUnit
            #{item.functionBrief},       -- 取functionBrief
            #{item.deploymentForm},      -- 取deploymentForm
            #{item.bearingNetwork},      -- 取bearingNetwork
            #{item.softwareCopyright},   -- 取softwareCopyright
            #{item.unitPrice},           -- 取unitPrice
            #{item.amount},              -- 取amount
            #{item.pricingMethod},       -- 取pricingMethod
            #{item.pricingDescription},  -- 取pricingDescription
            #{item.inventoryRemark},     -- 取inventoryRemark
            #{item.valuationRemark},     -- 取valuationRemark
            #{item.originalAccountRemark}, -- 取originalAccountRemark
            NOW()                       -- create_time：数据库当前时间（NOW()是MySQL函数）
            )
        </foreach>
    </insert>

    <!-- 实现selectByReportUnitAndCategory方法：组合查询 -->
    <!-- resultType：SQL结果类型（软件资产实体，需写全路径，或在application.yml配置type-aliases-package简化） -->
    <select id="selectByReportUnitAndCategory" resultType="com.military.asset.entity.SoftwareAsset">
        SELECT * FROM software_asset
        <!-- where标签：自动处理AND关键字（若第一个条件不满足，不会多余AND） -->
        <where>
            <!-- if标签：条件判断，参数非空才添加WHERE条件 -->
            <if test="reportUnit != null and reportUnit.trim() != ''">
                report_unit = #{reportUnit} -- 上报单位筛选
            </if>
            <if test="assetCategory != null and assetCategory.trim() != ''">
                AND asset_category = #{assetCategory} -- 资产分类筛选（加AND，避免SQL语法错误）
            </if>
        </where>
        ORDER BY create_time DESC -- 按入库时间倒序，最新数据在前
    </select>

    <!-- 实现selectAssetCategoryByCode方法：按分类编码查资产分类 -->
    <!-- DISTINCT：去重，确保同一编码只返回一个分类（符合一一对应规则） -->
    <select id="selectAssetCategoryByCode" resultType="java.lang.String">
        SELECT DISTINCT asset_category
        FROM software_asset
        WHERE category_code = #{categoryCode}
    </select>

    <!-- 统计各上报单位的软件资产数量，用于取得方式与服务状态占比分析 -->
    <select id="selectStatisticsByReportUnit" resultType="com.military.asset.vo.stat.SoftwareAssetStatisticRow">
        SELECT
            report_unit AS reportUnit,
            SUM(COALESCE(actual_quantity, 0)) AS totalQuantity,
            SUM(CASE WHEN acquisition_method = '购置' THEN COALESCE(actual_quantity, 0) ELSE 0 END) AS purchaseQuantity,
            SUM(CASE WHEN acquisition_method = '自主开发' THEN COALESCE(actual_quantity, 0) ELSE 0 END) AS selfDevelopedQuantity,
            SUM(CASE WHEN acquisition_method = '合作开发' THEN COALESCE(actual_quantity, 0) ELSE 0 END) AS coDevelopedQuantity,
            SUM(CASE WHEN acquisition_method = '其他' THEN COALESCE(actual_quantity, 0) ELSE 0 END) AS otherQuantity,
            SUM(CASE WHEN service_status = '在用' THEN COALESCE(actual_quantity, 0) ELSE 0 END) AS inUseQuantity,
            SUM(CASE WHEN service_status = '闲置' THEN COALESCE(actual_quantity, 0) ELSE 0 END) AS idleQuantity
        FROM software_asset
        GROUP BY report_unit
        ORDER BY report_unit
    </select>


</mapper>